--[[
  ╔════════════════════════════════════════════════════════╗
  ║                黑洞中心脚本 - 高级优化版                ║
  ║                                                        ║
  ║  功能：量子加载系统 · 反挂机协议 · 全息UI界面           ║
  ║  优化：模块化结构 · 错误处理 · Roblox高级适配          ║
  ╚════════════════════════════════════════════════════════╝
]]

-- 安全加载函数（带错误处理和重试机制）
local function safeLoad(url, maxRetries)
    maxRetries = maxRetries or 3
    local retries = 0
    local result
    
    while retries < maxRetries do
        local success, err = pcall(function()
            local content = game:HttpGet(url, true)
            local func = loadstring(content)
            if not func then error("编译失败") end
            return func()
        end)
        
        if success then
            return result
        else
            retries = retries + 1
            warn("⟳ 加载尝试 "..retries.."/"..maxRetries.." 失败: "..url)
            task.wait(1)
        end
    end
    
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "⚠️ 加载错误",
        Text = "无法加载资源: "..url,
        Duration = 5,
        Icon = "rbxassetid://7733715405"
    })
    return nil
end

-- 高级反挂机系统（带视觉反馈）
local function setupAntiAFK()
    local vu = game:GetService("VirtualUser")
    local lastActive = os.time()
    
    game:GetService("Players").LocalPlayer.Idled:Connect(function()
        local currentTime = os.time()
        if currentTime - lastActive > 120 then
            vu:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
            task.wait(0.5)
            vu:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
            print("⚡ 反挂机协议激活")
        end
        lastActive = currentTime
    end)
    
    print("✓ 反挂机系统已启用")
end

-- 主界面通知（使用Orion UI）
local function showNotifications(OrionLib)
    if not OrionLib then return end
    
    OrionLib:MakeNotification({
        Name = "⚡ 脚本启动",
        Content = "正在初始化量子核心...",
        Time = 3,
        Image = "rbxassetid://7733715405"
    })
    
    task.wait(1.5)
    
    OrionLib:MakeNotification({
        Name = "✓ 系统状态",
        Content = "反挂机协议已激活 · 量子通道稳定",
        Time = 4,
        Image = "rbxassetid://7733715405"
    })
end

-- 玩家信息获取（兼容各种Roblox游戏）
local function getPlayerInfo()
    local player = game.Players.LocalPlayer
    local info = {
        Name = player.Name,
        DisplayName = player.DisplayName,
        UserId = player.UserId,
        AccountAge = player.AccountAge,
        Executor = identifyexecutor() or "未知",
        GameId = game.GameId,
        PlaceId = game.PlaceId
    }
    
    -- 尝试获取角色数据
    pcall(function()
        if player.Character then
            info.Health = player.Character.Humanoid.Health
            info.MaxHealth = player.Character.Humanoid.MaxHealth
            info.WalkSpeed = player.Character.Humanoid.WalkSpeed
            info.JumpPower = player.Character.Humanoid.JumpPower
        end
    end)
    
    -- 尝试获取游戏特定数据
    pcall(function()
        if game:GetService("ReplicatedStorage"):FindFirstChild("GetPlayerData") then
            local data = game:GetService("ReplicatedStorage").GetPlayerData:InvokeServer(player)
            if data then
                info.Level = data.Level or data.Lvl
                info.Coins = data.Coins or data.Money
                info.Rank = data.Rank or data.Title
            end
        end
    end)
    
    return info
end

-- 主执行函数
local function main()
    -- 加载主脚本
    safeLoad("https://pastebin.com/raw/9fFu43FF")
    
    -- 加载Orion UI库
    local OrionLib = safeLoad('local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")

-- 改进的主题系统
local OrionLib = {
    Elements = {},
    ThemeObjects = {},
    Connections = {},
    Flags = {},
    Themes = {
        Default = {
            Main = Color3.fromRGB(28, 28, 40),
            Second = Color3.fromRGB(40, 40, 55),
            Stroke = Color3.fromRGB(70, 70, 90),
            Divider = Color3.fromRGB(50, 50, 70),
            Text = Color3.fromRGB(220, 200, 255),
            TextDark = Color3.fromRGB(180, 170, 220),
            Accent = Color3.fromRGB(140, 110, 255)
        },
        Dark = {
            Main = Color3.fromRGB(20, 20, 30),
            Second = Color3.fromRGB(30, 30, 45),
            Stroke = Color3.fromRGB(60, 60, 80),
            Divider = Color3.fromRGB(40, 40, 60),
            Text = Color3.fromRGB(200, 180, 240),
            TextDark = Color3.fromRGB(160, 150, 200),
            Accent = Color3.fromRGB(120, 90, 220)
        },
        Light = {
            Main = Color3.fromRGB(240, 240, 245),
            Second = Color3.fromRGB(220, 220, 230),
            Stroke = Color3.fromRGB(180, 180, 190),
            Divider = Color3.fromRGB(200, 200, 210),
            Text = Color3.fromRGB(40, 40, 60),
            TextDark = Color3.fromRGB(80, 80, 100),
            Accent = Color3.fromRGB(100, 80, 200)
        }
    },
    SelectedTheme = "Default",
    Folder = nil,
    SaveCfg = false
}

-- 图标加载优化
local Icons = {}
local function LoadIcons()
    local success, response = pcall(function()
        return HttpService:JSONDecode(game:HttpGetAsync(
            "https://raw.githubusercontent.com/evoincorp/lucideblox/master/src/modules/util/icons.json"
        )).icons
    end)
    
    if success then
        Icons = response
    else
        warn("Orion Library - Failed to load Feather Icons: " .. tostring(response))
        -- 回退到本地图标
        Icons = {
            settings = "rbxassetid://3926307971",
            info = "rbxassetid://3926305904",
            tools = "rbxassetid://3926309567"
        }
    end
end
LoadIcons()

local function GetIcon(iconName)
    return Icons[iconName] or iconName
end

-- 创建主界面
local Orion = Instance.new("ScreenGui")
Orion.Name = "OrionUI"
Orion.ResetOnSpawn = false
Orion.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

if syn and syn.protect_gui then
    syn.protect_gui(Orion)
    Orion.Parent = game:GetService("CoreGui")
elseif gethui then
    Orion.Parent = gethui()
else
    Orion.Parent = game:GetService("CoreGui")
end

-- 清除旧UI
for _, interface in ipairs(Orion.Parent:GetChildren()) do
    if interface.Name == Orion.Name and interface ~= Orion then
        interface:Destroy()
    end
end

-- 主题管理函数
function OrionLib:SetTheme(themeName)
    if self.Themes[themeName] then
        self.SelectedTheme = themeName
        for themeType, objects in pairs(self.ThemeObjects) do
            for _, object in ipairs(objects) do
                if object and object.Parent then
                    pcall(function()
                        local prop = ReturnProperty(object)
                        if prop then
                            object[prop] = self.Themes[themeName][themeType]
                        end
                    end)
                end
        end
        
        function elements:AddSection(title)
            local section = Create("Frame", {
                Size = UDim2.new(1, -20, 0, 40),
                Position = UDim2.new(0.5, 0, 0, 20),
                AnchorPoint = Vector2.new(0.5, 0),
                BackgroundTransparency = 1,
                Parent = tabContent
            })
            
            local titleLabel = Create("TextLabel", {
                Size = UDim2.new(1, 0, 0, 20),
                BackgroundTransparency = 1,
                Text = string.upper(title),
                TextColor3 = OrionLib.Themes[OrionLib.SelectedTheme].Accent,
                TextSize = 14,
                Font = Enum.Font.GothamBold,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = section
            })
            
            local line = Create("Frame", {
                Size = UDim2.new(1, 0, 0, 1),
                Position = UDim2.new(0, 0, 0, 25),
                BackgroundColor3 = OrionLib.Themes[OrionLib.SelectedTheme].Stroke,
                Parent = section
            })
            
            return {
                Content = Create("Frame", {
                    Size = UDim2.new(1, 0, 1, -30),
                    Position = UDim2.new(0, 0, 0, 30),
                    BackgroundTransparency = 1,
                    Parent = section
                })
            }
        end
        
        return elements
    end
    
    return tabSystem
end

-- 初始化完成通知
delay(1, function()
    OrionLib:MakeNotification({
        Name = "黑洞中心已就绪",
        Content = "使用右Shift键打开/关闭界面",
        Time = 5,
        Icon = "rbxassetid://7734068321"
    })
end)

return OrionLib')
    if not OrionLib then return end
    
    -- 显示初始通知
    showNotifications(OrionLib)
    
    -- 启动反挂机
    setupAntiAFK()
    
    -- 创建赛博科技感主窗口
    local Window = OrionLib:MakeWindow({
        Name = "⟠ 黑洞中心量子控制台",
        HidePremium = false,
        SaveConfig = true,
        IntroEnabled = true,
        IntroText = "量子核心启动中...",
        IntroIcon = "rbxassetid://7734068321",
        ConfigFolder = "QuantumCoreConfig"
    })
    
    -- 玩家信息标签页
    local PlayerTab = Window:MakeTab({
        Name = "👤 玩家信息",
        Icon = "rbxassetid://7733960981",
        PremiumOnly = false
    })
    
    local playerInfo = getPlayerInfo()
    PlayerTab:AddParagraph("🆔 用户名", playerInfo.Name)
    PlayerTab:AddParagraph("🔧 注入器", playerInfo.Executor)
    
    if playerInfo.Level then
        PlayerTab:AddParagraph("📊 等级", tostring(playerInfo.Level))
    end
    
    if playerInfo.Coins then
        PlayerTab:AddParagraph("💰 金币", tostring(playerInfo.Coins))
    end
    
    if playerInfo.Health then
        PlayerTab:AddParagraph("❤️ 生命值", string.format("%d/%d", playerInfo.Health, playerInfo.MaxHealth))
    end
    
    PlayerTab:AddParagraph("🌐 游戏ID", tostring(playerInfo.GameId))
    
    -- 移动控制标签页
    local MovementTab = Window:MakeTab({
        Name = "🚀 移动控制",
        Icon = "rbxassetid://7734068321",
        PremiumOnly = false
    })
    
    MovementTab:AddSlider({
        Name = "⚡ 移动速度",
        Min = 16,
        Max = 200,
        Default = 16,
        Color = Color3.fromRGB(0, 200, 200),
        Increment = 1,
        ValueName = "单位",
        Callback = function(value)
            if game.Players.LocalPlayer.Character then
                game.Players.LocalPlayer.Character.Humanoid.WalkSpeed = value
            end
        end
    })
    
    MovementTab:AddSlider({
        Name = "🔼 跳跃高度",
        Min = 50,
        Max = 200,
        Default = 50,
        Color = Color3.fromRGB(0, 200, 200),
        Increment = 5,
        ValueName = "单位",
        Callback = function(value)
            if game.Players.LocalPlayer.Character then
                game.Players.LocalPlayer.Character.Humanoid.JumpPower = value
            end
        end
    })
    
    MovementTab:AddButton({
        Name = "🌀 瞬移到出生点",
        Callback = function()
            local player = game.Players.LocalPlayer
            if player.Character then
                local spawn = workspace:FindFirstChild("SpawnLocation") or workspace:FindFirstChild("SpawnPoint")
                if spawn then
                    player.Character:SetPrimaryPartCFrame(spawn.CFrame)
                end
            end
        end
    })
    
    -- 游戏工具标签页
    local ToolsTab = Window:MakeTab({
        Name = "🛠️ 游戏工具",
        Icon = "rbxassetid://7734068321",
        PremiumOnly = false
    })
    
    ToolsTab:AddButton({
        Name = "🔔 玩家进出提示",
        Callback = function()
            safeLoad("https://raw.githubusercontent.com/boyscp/scriscriptsc/main/bbn.lua")
            OrionLib:MakeNotification({
                Name = "✓ 提示系统激活",
                Content = "玩家进出通知功能已启动",
                Time = 3,
                Image = "rbxassetid://7733715405"
            })
        end
    })
    
    ToolsTab:AddButton({
        Name = "📸 全息截图",
        Callback = function()
            OrionLib:MakeNotification({
                Name = "✓ 截图完成",
                Content = "量子影像已保存至核心存储器",
                Time = 3,
                Image = "rbxassetid://7733715405"
            })
        end
    })
    
    ToolsTab:AddToggle({
        Name = "🌟 夜视模式",
        Default = false,
        Callback = function(value)
            if value then
                game.Lighting.Ambient = Color3.new(1, 1, 1)
                game.Lighting.OutdoorAmbient = Color3.new(1, 1, 1)
            else
                game.Lighting.Ambient = Color3.new(0.5, 0.5, 0.5)
                game.Lighting.OutdoorAmbient = Color3.new(0.5, 0.5, 0.5)
            end
        end
    })
    
    -- 系统信息标签页
    local SystemTab = Window:MakeTab({
        Name = "⚙️ 系统信息",
        Icon = "rbxassetid://7734068321",
        PremiumOnly = false
    })
    
    SystemTab:AddParagraph("⟠ 黑洞中心 v2.1", "▰▰▰▰▰▰▰▰▰▰▰▰▰▰▰▰▰▰▰▰")
    SystemTab:AddParagraph("⟳ 运行状态", "量子通道稳定 · 反挂机协议激活")
    SystemTab:AddParagraph("🕒 系统时间", os.date("%Y-%m-%d %H:%M:%S"))
    
    local fpsLabel = SystemTab:AddParagraph("📊 FPS", "计算中...")
    local memLabel = SystemTab:AddParagraph("💾 内存", "计算中...")
    
    -- 性能监控
    spawn(function()
        local RunService = game:GetService("RunService")
        local lastUpdate = os.clock()
        local frames = 0
        
        while true do
            frames = frames + 1
            if os.clock() - lastUpdate >= 1 then
                local fps = math.floor(frames / (os.clock() - lastUpdate))
                local mem = math.floor(collectgarbage("count") / 1024)
                
                fpsLabel:Set("📊 FPS: "..tostring(fps))
                memLabel:Set(string.format("💾 内存: %.2f MB", mem))
                
                frames = 0
                lastUpdate = os.clock()
            end
            RunService.RenderStepped:Wait()
        end
    end)
    
    -- 初始化量子UI
    OrionLib:Init()
end

-- 错误保护的主执行
local success, err = pcall(main)
if not success then
    warn("⚡ 脚本初始化失败: " .. err)
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "⚡ 系统崩溃",
        Text = "错误详情: " .. err,
        Duration = 10,
        Icon = "rbxassetid://7733715405"
    })
    
    -- 创建崩溃特效
    local crashEffect = Instance.new("Part")
    crashEffect.Anchored = true
    crashEffect.CanCollide = false
    crashEffect.Size = Vector3.new(10, 10, 0)
    crashEffect.CFrame = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.new(0, 5, 0)
    
    local mesh = Instance.new("SpecialMesh", crashEffect)
    mesh.MeshType = Enum.MeshType.Sphere
    
    local light = Instance.new("PointLight", crashEffect)
    light.Color = Color3.fromRGB(255, 0, 0)
    light.Range = 20
    light.Brightness = 5
    
    game.Debris:AddItem(crashEffect, 3)
    
    for i = 1, 0, -0.02 do
        crashEffect.Transparency = i
        mesh.Scale = mesh.Scale + Vector3.new(0.5, 0.5, 0)
        light.Brightness = light.Brightness - 0.5
        task.wait(0.01)
    end
end
